"use strict";(self.webpackChunkstencil=self.webpackChunkstencil||[]).push([[958],{3905:function(e,t,n){n.d(t,{Zo:function(){return p},kt:function(){return u}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var s=a.createContext({}),c=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},p=function(e){var t=c(e.components);return a.createElement(s.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,p=l(e,["components","mdxType","originalType","parentName"]),d=c(n),u=r,f=d["".concat(s,".").concat(u)]||d[u]||m[u]||o;return n?a.createElement(f,i(i({ref:t},p),{},{components:n})):a.createElement(f,i({ref:t},p))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:r,i[1]=l;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7208:function(e,t,n){n.r(t),n.d(t,{assets:function(){return p},contentTitle:function(){return s},default:function(){return u},frontMatter:function(){return l},metadata:function(){return c},toc:function(){return m}});var a=n(7462),r=n(3366),o=(n(7294),n(3905)),i=["components"],l={},s="Overview",c={unversionedId:"server/overview",id:"server/overview",title:"Overview",description:"Stencil is dynamic protobuf schema registry. It provides REST interface for storing and retrieving protobuf file descriptors.",source:"@site/docs/server/overview.md",sourceDirName:"server",slug:"/server/overview",permalink:"/stencil/docs/server/overview",editUrl:"https://github.com/goto/stencil/edit/master/docs/docs/server/overview.md",tags:[],version:"current",frontMatter:{},sidebar:"docsSidebar",previous:{title:"JSON",permalink:"/stencil/docs/formats/json"},next:{title:"Compatability rules",permalink:"/stencil/docs/server/rules"}},p={},m=[{value:"Features",id:"features",level:2},{value:"Requirements",id:"requirements",level:2},{value:"Installation",id:"installation",level:2},{value:"Configuring environment Variables",id:"configuring-environment-variables",level:3},{value:"Reference",id:"reference",level:2},{value:"Quick start API usage examples",id:"quick-start-api-usage-examples",level:2}],d={toc:m};function u(e){var t=e.components,n=(0,r.Z)(e,i);return(0,o.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,o.kt)("h1",{id:"overview"},"Overview"),(0,o.kt)("p",null,"Stencil is dynamic protobuf schema registry. It provides REST interface for storing and retrieving protobuf file descriptors."),(0,o.kt)("h2",{id:"features"},"Features"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"stores versioned history of proto descriptor file on specified namespace and name"),(0,o.kt)("li",{parentName:"ul"},"enforce backward compatibility check on upload by default"),(0,o.kt)("li",{parentName:"ul"},"ability to skip some of the backward compatibility checks while upload"),(0,o.kt)("li",{parentName:"ul"},"ability to download fully contained proto descriptor file for specified proto message ",(0,o.kt)("a",{parentName:"li",href:"https://pkg.go.dev/google.golang.org/protobuf@v1.27.1/reflect/protoreflect#FullName"},"fullName")),(0,o.kt)("li",{parentName:"ul"},"provides metadata API to retrieve latest version number given a name and namespace")),(0,o.kt)("h2",{id:"requirements"},"Requirements"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},"postgres 13"),(0,o.kt)("li",{parentName:"ul"},"kafka 3.7.0")),(0,o.kt)("h2",{id:"installation"},"Installation"),(0,o.kt)("p",null,"Run the following commands to run from docker image"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ docker pull gotocompany/stencil\n")),(0,o.kt)("p",null,"Run the following commands to compile from source"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},"$ git clone git@github.com:goto/stencil.git\n$ cd stencil\n$ go build -o stencil\n$ ./stencil --help\n\n# Create a sample config file.\n$ cp config/config.yaml config.yaml\n\n$ ./stencil server start -c config.yaml\n\n")),(0,o.kt)("h3",{id:"configuring-environment-variables"},"Configuring environment Variables"),(0,o.kt)("p",null,"You can also specfify stencil server configurations through following environment variables.\nNote: ENV vars takes more precendence over config file."),(0,o.kt)("table",null,(0,o.kt)("thead",{parentName:"table"},(0,o.kt)("tr",{parentName:"thead"},(0,o.kt)("th",{parentName:"tr",align:"left"},"ENV"),(0,o.kt)("th",{parentName:"tr",align:"left"},"Description"))),(0,o.kt)("tbody",{parentName:"table"},(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"PORT")),(0,o.kt)("td",{parentName:"tr",align:"left"},"port number default to ",(0,o.kt)("inlineCode",{parentName:"td"},"8080"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"TIMEOUT")),(0,o.kt)("td",{parentName:"tr",align:"left"},"graceful time to wait before shutting down the server. Takes ",(0,o.kt)("inlineCode",{parentName:"td"},"time.Duration")," format. Eg: ",(0,o.kt)("inlineCode",{parentName:"td"},"30s")," or ",(0,o.kt)("inlineCode",{parentName:"td"},"20m"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"DB_CONNECTIONSTRING")),(0,o.kt)("td",{parentName:"tr",align:"left"},"postgres db connection ",(0,o.kt)("a",{parentName:"td",href:"https://www.postgresql.org/docs/11/libpq-connect.html#LIBPQ-CONNSTRING"},"url"),". Eg: ",(0,o.kt)("inlineCode",{parentName:"td"},"postgres://postgres@localhost:5432/db_name"))),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"NEWRELIC_ENABLED")),(0,o.kt)("td",{parentName:"tr",align:"left"},"boolean to enable newrelic")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"NEWRELIC_APPNAME")),(0,o.kt)("td",{parentName:"tr",align:"left"},"appname")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"NEWRELIC_LICENSE")),(0,o.kt)("td",{parentName:"tr",align:"left"},"License key for newrelic")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"KAFKAPRODUCER_BOOTSTRAPSERVER")),(0,o.kt)("td",{parentName:"tr",align:"left"},"bootstrap server for kafka")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"KAFKAPRODUCER_RETRIES")),(0,o.kt)("td",{parentName:"tr",align:"left"},"Number of retries for producer if publish to kafka topic fails")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"KAFKAPRODUCER_TIMEOUT")),(0,o.kt)("td",{parentName:"tr",align:"left"},"Timeout for write operation performed by the Writer.")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"SCHEMACHANGE_ENABLE")),(0,o.kt)("td",{parentName:"tr",align:"left"},"flag to enable change detector")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"SCHEMACHANGE_KAFKATOPIC")),(0,o.kt)("td",{parentName:"tr",align:"left"},"name of kafka topic to which messages related to SchemaChangeEvent will be published")),(0,o.kt)("tr",{parentName:"tbody"},(0,o.kt)("td",{parentName:"tr",align:"left"},(0,o.kt)("inlineCode",{parentName:"td"},"SCHEMACHANGE_DEPTH")),(0,o.kt)("td",{parentName:"tr",align:"left"},"Depth to which indirectly impacted schemas are processed. If empty or -1, it will process all indirectly impacted schemas.")))),(0,o.kt)("h2",{id:"reference"},"Reference"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/stencil/docs/reference/api"},"API")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"/stencil/docs/server/rules"},"Rules"))),(0,o.kt)("h2",{id:"quick-start-api-usage-examples"},"Quick start API usage examples"),(0,o.kt)("p",null,"The following assumes you have Stencil server up and running at port 8080 and ",(0,o.kt)("inlineCode",{parentName:"p"},"protoc")," is installed."),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-bash"},'$ mkdir example\n$ cd example\n# create example proto file. You can add as many proto files as you want.\n$ echo "syntax=\\"proto3\\";\\npackage stencil;\\nmessage One {\\n  int32 field_one = 1;\\n}" > 1.proto\n\n# create descriptor file\n$ protoc --descriptor_set_out=./file.desc --include_imports ./1.proto\n\n# create namespace named "quickstart" with backward compatibility enabled\ncurl -X POST http://localhost:8000/v1beta1/namespaces -H \'Content-Type: application/json\' -d \'{"id": "quickstart", "format": "FORMAT_PROTOBUF", "compatibility": "COMPATIBILITY_BACKWARD", "description": "This field can be used to store namespace description"}\'\n\n# list namespaces\ncurl http://localhost:8000/v1beta1/namespaces\n\n# upload generated proto descriptor file to server with schema name as `example` under `quickstart` namespace.\ncurl -H "X-SourceURL:www.github.com/some-repo" -H "X-CommitSHA:some-commit-sha" -X POST http://localhost:8000/v1beta1/namespaces/quickstart/schemas/example --data-binary "@file.desc"\n\n# get list of schemas available in a namespace\ncurl -X GET http://localhost:8000/v1beta1/namespaces/quickstart/schemas\n\n# get list of versions available for particular schema. These versions are auto generated. Version numbers managed by stencil.\ncurl -X GET http://localhost:8000/v1beta1/namespaces/quickstart/schemas/example/versions\n\n# download specific version of particular schema\ncurl -X GET http://localhost:8000/v1beta1/namespaces/quickstart/schemas/example/versions/1\n\n# download latest version of particular schema\ncurl -X GET http://localhost:8000/v1beta1/namespaces/quickstart/schemas/example;\n\n# now let\'s try uploading breaking proto definition. Note that proto field number has changed from 1 to 2.\necho "syntax=\\"proto3\\";\\npackage stencil;\\nmessage One {\\n  int32 field_one = 2;\\n}" > one.proto;\n\n# create descriptor file\nprotoc --descriptor_set_out=./file.desc --include_imports ./**/*.proto;\n\n# now try to upload this descriptor file with same name as before. This call should fail, giving you reason it has failed.\ncurl -H "X-SourceURL:www.github.com/some-repo" -H "X-CommitSHA:some-commit-sha"  -X POST http://localhost:8000/v1/namespaces/quickstart/schemas --data-binary "@file.desc";\n\n# now let\'s try fixing our proto add a new field without having any breaking changes.\necho "syntax=\\"proto3\\";\\npackage stencil;\\nmessage One {\\n  int32 field_one = 1;\\nint32 field_two = 2;\\n}" > one.proto;\n\n# create descriptor file\nprotoc --descriptor_set_out=./file.desc --include_imports ./**/*.proto\n\n# now try to upload this descriptor file with same name as before. This call should succeed\ncurl -H "X-SourceURL:www.github.com/some-repo" -H "X-CommitSHA:some-commit-sha"  -X POST http://localhost:8000/v1/namespaces/quickstart/schemas --data-binary "@file.desc"\n\n# now try versions api. It should have 2 versions now.\ncurl -X GET http://localhost:8000/v1beta1/namespaces/quickstart/schemas/example/versions\n\n# upload schema can be called multiple times. Stencil server will retain old version if it\'s already uploaded. This call won\'t create new version again. You can verify by using versions API again.\ncurl -H "X-SourceURL:www.github.com/some-repo" -H "X-CommitSHA:some-commit-sha" -X POST http://localhost:8000/v1/namespaces/quickstart/schemas --data-binary "@file.desc"\n')))}u.isMDXComponent=!0}}]);